<template>
  <div class="project-detail">
    <!-- é¡µé¢å¤´éƒ¨ -->
    <div class="page-header">
      <div class="header-left">
        <button @click="goBack" class="btn-back">
          <span class="icon">â†</span>
          <span>è¿”å›</span>
        </button>
        <h1 v-if="project">{{ project.name }}</h1>
        <h1 v-else>é¡¹ç›®è¯¦æƒ…</h1>
      </div>
      <div class="header-actions">
        <button @click="refreshData" :disabled="loading" class="btn-secondary">
          <span class="icon">ğŸ”„</span>
          <span>åˆ·æ–°</span>
        </button>
      </div>
    </div>

    <!-- åŠ è½½çŠ¶æ€ -->
    <div v-if="loading" class="loading-state">
      <span class="icon">â³</span>
      <p>æ­£åœ¨åŠ è½½é¡¹ç›®ä¿¡æ¯...</p>
    </div>

    <!-- é¡¹ç›®ä¸å­˜åœ¨ -->
    <div v-else-if="!project" class="error-state">
      <span class="icon">âŒ</span>
      <h2>é¡¹ç›®ä¸å­˜åœ¨</h2>
      <p>è¯·æ£€æŸ¥é¡¹ç›®IDæ˜¯å¦æ­£ç¡®</p>
      <button @click="goBack" class="btn-primary">è¿”å›é¡¹ç›®åˆ—è¡¨</button>
    </div>

    <!-- é¡¹ç›®è¯¦æƒ…å†…å®¹ -->
    <div v-else class="project-content">
      <!-- åŸºæœ¬ä¿¡æ¯å¡ç‰‡ -->
      <div class="info-card">
        <div class="card-header">
          <h2>åŸºæœ¬ä¿¡æ¯</h2>
        </div>
        <div class="card-body">
          <div class="info-grid">
            <div class="info-item">
              <label>é¡¹ç›®åç§°ï¼š</label>
              <span>{{ project.name }}</span>
            </div>
            <div class="info-item">
              <label>é¡¹ç›®è·¯å¾„ï¼š</label>
              <span class="path-text">{{ project.path }}</span>
            </div>
            <div class="info-item">
              <label>é¡¹ç›®æè¿°ï¼š</label>
              <span>{{ project.description || 'æš‚æ— æè¿°' }}</span>
            </div>
            <div class="info-item">
              <label>åˆ›å»ºæ—¶é—´ï¼š</label>
              <span>{{ formatDate(project.createdAt) }}</span>
            </div>
            <div class="info-item">
              <label>æ›´æ–°æ—¶é—´ï¼š</label>
              <span>{{ formatDate(project.updatedAt) }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Package.json ä¿¡æ¯å¡ç‰‡ -->
      <div class="info-card">
        <div class="card-header">
          <h2>Package.json ä¿¡æ¯</h2>
          <button @click="refreshPackageJson" :disabled="packageLoading" class="btn-small">
            <span v-if="packageLoading">â³</span>
            <span v-else>ğŸ”„</span>
          </button>
        </div>
        <div class="card-body">
          <div v-if="packageLoading" class="loading-state-small">
            <span class="icon">â³</span>
            <span>æ­£åœ¨è¯»å– package.json...</span>
          </div>
          
          <div v-else-if="!packageJson" class="error-state-small">
            <span class="icon">âŒ</span>
            <span>æ— æ³•è¯»å– package.json æ–‡ä»¶</span>
          </div>
          
          <div v-else class="package-info">
            <div class="info-grid">
              <div class="info-item">
                <label>åŒ…åï¼š</label>
                <span>{{ packageJson.name || 'æœªè®¾ç½®' }}</span>
              </div>
              <div class="info-item">
                <label>ç‰ˆæœ¬ï¼š</label>
                <span>{{ packageJson.version || 'æœªè®¾ç½®' }}</span>
              </div>
              <div class="info-item">
                <label>æè¿°ï¼š</label>
                <span>{{ packageJson.description || 'æœªè®¾ç½®' }}</span>
              </div>
              <div class="info-item">
                <label>ä½œè€…ï¼š</label>
                <span>{{ formatAuthor(packageJson.author) || 'æœªè®¾ç½®' }}</span>
              </div>
              <div class="info-item">
                <label>è®¸å¯è¯ï¼š</label>
                <span>{{ packageJson.license || 'æœªè®¾ç½®' }}</span>
              </div>
              <div class="info-item">
                <label>ä¸»å…¥å£ï¼š</label>
                <span>{{ packageJson.main || 'æœªè®¾ç½®' }}</span>
              </div>
            </div>

            <!-- è„šæœ¬å‘½ä»¤ -->
            <div v-if="packageJson.scripts" class="scripts-section">
              <h3>è„šæœ¬å‘½ä»¤</h3>
              <div class="scripts-grid">
                <div 
                  v-for="(script, name) in packageJson.scripts" 
                  :key="name"
                  class="script-item"
                >
                  <div class="script-name">{{ name }}</div>
                  <div class="script-command">{{ script }}</div>
                </div>
              </div>
            </div>

            <!-- ä¾èµ–ä¿¡æ¯ -->
            <div class="dependencies-section">
              <div v-if="packageJson.dependencies" class="dep-group">
                <h3>ç”Ÿäº§ä¾èµ– ({{ Object.keys(packageJson.dependencies).length }})</h3>
                <div class="dependencies-grid">
                  <div 
                    v-for="(version, name) in packageJson.dependencies" 
                    :key="name"
                    class="dependency-item"
                  >
                    <span class="dep-name">{{ name }}</span>
                    <span class="dep-version">{{ version }}</span>
                  </div>
                </div>
              </div>

              <div v-if="packageJson.devDependencies" class="dep-group">
                <h3>å¼€å‘ä¾èµ– ({{ Object.keys(packageJson.devDependencies).length }})</h3>
                <div class="dependencies-grid">
                  <div 
                    v-for="(version, name) in packageJson.devDependencies" 
                    :key="name"
                    class="dependency-item dev-dep"
                  >
                    <span class="dep-name">{{ name }}</span>
                    <span class="dep-version">{{ version }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- é”™è¯¯æç¤º -->
    <div v-if="error" class="error-toast">
      <span class="icon">âŒ</span>
      <span>{{ error }}</span>
      <button @click="error = ''" class="btn-close">âœ•</button>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted } from 'vue'
import { useRoute, useRouter } from 'vue-router'
import { useApi } from '../composables/useApi'

// è·¯ç”±
const route = useRoute()
const router = useRouter()

// API å®ä¾‹
const api = useApi()

// å“åº”å¼æ•°æ®
const loading = ref(false)
const packageLoading = ref(false)
const project = ref<any>(null)
const packageJson = ref<any>(null)
const error = ref('')

// æ ¼å¼åŒ–æ—¥æœŸ
const formatDate = (dateString: string) => {
  return new Date(dateString).toLocaleString('zh-CN')
}

// æ ¼å¼åŒ–ä½œè€…ä¿¡æ¯
const formatAuthor = (author: any) => {
  if (!author) return ''
  if (typeof author === 'string') return author
  if (typeof author === 'object') {
    const parts = []
    if (author.name) parts.push(author.name)
    if (author.email) parts.push(`<${author.email}>`)
    return parts.join(' ')
  }
  return ''
}

// è·å–é¡¹ç›®è¯¦æƒ…
const getProjectDetail = async () => {
  const projectId = route.params.id as string
  if (!projectId) return

  loading.value = true
  error.value = ''
  
  try {
    const response = await api.get(`/api/projects/${projectId}`)
    if (response.success) {
      project.value = response.data
    } else {
      error.value = response.message || 'è·å–é¡¹ç›®è¯¦æƒ…å¤±è´¥'
    }
  } catch (err) {
    error.value = err instanceof Error ? err.message : 'è·å–é¡¹ç›®è¯¦æƒ…å¤±è´¥'
  } finally {
    loading.value = false
  }
}

// è·å– package.json ä¿¡æ¯
const getPackageJson = async () => {
  const projectId = route.params.id as string
  if (!projectId) return

  packageLoading.value = true
  
  try {
    const response = await api.get(`/api/projects/${projectId}/package`)
    if (response.success) {
      packageJson.value = response.data
    } else {
      console.warn('è·å–package.jsonå¤±è´¥:', response.message)
      packageJson.value = null
    }
  } catch (err) {
    console.warn('è·å–package.jsonå¤±è´¥:', err)
    packageJson.value = null
  } finally {
    packageLoading.value = false
  }
}

// åˆ·æ–°æ•°æ®
const refreshData = async () => {
  await Promise.all([
    getProjectDetail(),
    getPackageJson()
  ])
}

// åˆ·æ–° package.json
const refreshPackageJson = () => {
  getPackageJson()
}

// è¿”å›ä¸Šä¸€é¡µ
const goBack = () => {
  router.push('/projects')
}

// ç»„ä»¶æŒ‚è½½æ—¶åŠ è½½æ•°æ®
onMounted(() => {
  refreshData()
})
</script>

<style scoped lang="less">
.project-detail {
  padding: var(--ls-padding-lg);
  max-width: 1200px;
  margin: 0 auto;
}

.page-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: var(--ls-margin-lg);

  .header-left {
    display: flex;
    align-items: center;
    gap: var(--ls-spacing-base);

    h1 {
      margin: 0;
      color: var(--ldesign-text-color-primary);
      font-size: var(--ls-font-size-h2);
    }
  }

  .header-actions {
    display: flex;
    gap: var(--ls-spacing-sm);
  }
}

.loading-state, .error-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: var(--ls-padding-xxl);
  text-align: center;

  .icon {
    font-size: 48px;
    margin-bottom: var(--ls-margin-base);
  }

  h2 {
    margin: 0 0 var(--ls-margin-sm) 0;
    color: var(--ldesign-text-color-primary);
  }

  p {
    margin: 0 0 var(--ls-margin-lg) 0;
    color: var(--ldesign-text-color-secondary);
  }
}

.project-content {
  display: flex;
  flex-direction: column;
  gap: var(--ls-spacing-lg);
}

.info-card {
  background: var(--ldesign-bg-color-container);
  border: 1px solid var(--ldesign-border-color);
  border-radius: var(--ls-border-radius-lg);
  overflow: hidden;
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: var(--ls-padding-lg);
  background: var(--ldesign-bg-color-component);
  border-bottom: 1px solid var(--ldesign-border-color);

  h2 {
    margin: 0;
    color: var(--ldesign-text-color-primary);
    font-size: var(--ls-font-size-lg);
    font-weight: 600;
  }

  .btn-small {
    background: none;
    border: 1px solid var(--ldesign-border-color);
    border-radius: var(--ls-border-radius-base);
    padding: var(--ls-padding-xs);
    cursor: pointer;
    font-size: 14px;
    transition: all 0.2s ease;

    &:hover:not(:disabled) {
      background: var(--ldesign-bg-color-component-hover);
      border-color: var(--ldesign-border-color-hover);
    }

    &:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
  }
}

.card-body {
  padding: var(--ls-padding-lg);
}

.loading-state-small, .error-state-small {
  display: flex;
  align-items: center;
  gap: var(--ls-spacing-sm);
  color: var(--ldesign-text-color-secondary);
  font-size: var(--ls-font-size-sm);
}

.info-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: var(--ls-spacing-base);
}

.info-item {
  display: flex;
  flex-direction: column;
  gap: var(--ls-spacing-xs);

  label {
    color: var(--ldesign-text-color-secondary);
    font-size: var(--ls-font-size-sm);
    font-weight: 500;
  }

  span {
    color: var(--ldesign-text-color-primary);
    font-size: var(--ls-font-size-sm);

    &.path-text {
      font-family: monospace;
      word-break: break-all;
      background: var(--ldesign-bg-color-component);
      padding: var(--ls-padding-xs);
      border-radius: var(--ls-border-radius-sm);
    }
  }
}

.scripts-section, .dependencies-section {
  margin-top: var(--ls-margin-lg);

  h3 {
    margin: 0 0 var(--ls-margin-base) 0;
    color: var(--ldesign-text-color-primary);
    font-size: var(--ls-font-size-base);
    font-weight: 600;
  }
}

.scripts-grid {
  display: grid;
  gap: var(--ls-spacing-sm);
}

.script-item {
  display: flex;
  align-items: center;
  gap: var(--ls-spacing-base);
  padding: var(--ls-padding-sm);
  background: var(--ldesign-bg-color-component);
  border-radius: var(--ls-border-radius-base);

  .script-name {
    min-width: 100px;
    color: var(--ldesign-brand-color);
    font-weight: 500;
    font-size: var(--ls-font-size-sm);
  }

  .script-command {
    flex: 1;
    color: var(--ldesign-text-color-secondary);
    font-family: monospace;
    font-size: var(--ls-font-size-xs);
    word-break: break-all;
  }
}

.dep-group {
  margin-bottom: var(--ls-margin-lg);

  &:last-child {
    margin-bottom: 0;
  }
}

.dependencies-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
  gap: var(--ls-spacing-xs);
  max-height: 300px;
  overflow-y: auto;
  border: 1px solid var(--ldesign-border-color);
  border-radius: var(--ls-border-radius-base);
  padding: var(--ls-padding-sm);
}

.dependency-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: var(--ls-padding-xs);
  border-radius: var(--ls-border-radius-sm);

  &:hover {
    background: var(--ldesign-bg-color-component-hover);
  }

  &.dev-dep {
    opacity: 0.8;
  }

  .dep-name {
    color: var(--ldesign-text-color-primary);
    font-size: var(--ls-font-size-xs);
    font-weight: 500;
  }

  .dep-version {
    color: var(--ldesign-text-color-secondary);
    font-size: var(--ls-font-size-xs);
    font-family: monospace;
  }
}

/* æŒ‰é’®æ ·å¼ */
.btn-primary, .btn-secondary, .btn-back {
  display: inline-flex;
  align-items: center;
  gap: var(--ls-spacing-xs);
  padding: var(--ls-padding-sm) var(--ls-padding-base);
  border: 1px solid transparent;
  border-radius: var(--ls-border-radius-base);
  font-size: var(--ls-font-size-sm);
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s ease;
  text-decoration: none;

  &:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }
}

.btn-primary {
  background: var(--ldesign-brand-color);
  color: white;

  &:hover:not(:disabled) {
    background: var(--ldesign-brand-color-hover);
  }
}

.btn-secondary {
  background: var(--ldesign-bg-color-component);
  color: var(--ldesign-text-color-primary);
  border-color: var(--ldesign-border-color);

  &:hover:not(:disabled) {
    background: var(--ldesign-bg-color-component-hover);
    border-color: var(--ldesign-border-color-hover);
  }
}

.btn-back {
  background: none;
  color: var(--ldesign-text-color-secondary);
  padding: var(--ls-padding-xs) var(--ls-padding-sm);

  &:hover {
    color: var(--ldesign-text-color-primary);
    background: var(--ldesign-bg-color-component-hover);
  }
}

/* é”™è¯¯æç¤ºæ ·å¼ */
.error-toast {
  position: fixed;
  top: 20px;
  right: 20px;
  display: flex;
  align-items: center;
  gap: var(--ls-spacing-sm);
  padding: var(--ls-padding-base);
  border-radius: var(--ls-border-radius-base);
  box-shadow: var(--ldesign-shadow-2);
  z-index: 1001;
  background: var(--ldesign-error-color-focus);
  color: var(--ldesign-error-color-8);
  border: 1px solid var(--ldesign-error-color-3);

  .btn-close {
    background: none;
    border: none;
    cursor: pointer;
    opacity: 0.7;

    &:hover {
      opacity: 1;
    }
  }
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
  .project-detail {
    padding: var(--ls-padding-base);
  }

  .page-header {
    flex-direction: column;
    gap: var(--ls-spacing-base);
    align-items: stretch;

    .header-left {
      flex-direction: column;
      align-items: flex-start;
      gap: var(--ls-spacing-sm);
    }

    .header-actions {
      justify-content: center;
    }
  }

  .info-grid {
    grid-template-columns: 1fr;
  }

  .dependencies-grid {
    grid-template-columns: 1fr;
  }

  .script-item {
    flex-direction: column;
    align-items: flex-start;

    .script-name {
      min-width: auto;
    }
  }
}
</style>
