/**
 * UI command: start server + web using dedicated launcher scripts
 *
 * ä½¿ç”¨ç‹¬ç«‹çš„å¯åŠ¨è„šæœ¬ï¼Œæ”¯æŒå¼€å‘å’Œç”Ÿäº§æ¨¡å¼
 */

import type { CAC } from 'cac'
import { existsSync } from 'fs'
import open from 'open'
import { logger } from '@ldesign/shared'
import type { CommandHandler } from '../core/CommandRegistry'
import { spawn, type ChildProcess } from 'child_process'
import { join, dirname } from 'path'
import { fileURLToPath } from 'url'
import { execa } from 'execa'

export interface UIOptions {
  host?: string
  open?: boolean
  dev?: boolean
  watch?: boolean // watch æ¨¡å¼ï¼ˆç­‰åŒäº devï¼Œå¯ç”¨çƒ­æ›´æ–°ï¼‰
  serverPort?: number
  webPort?: number
  serverOnly?: boolean
  webOnly?: boolean
  noBuild?: boolean
}

const __filename = fileURLToPath(import.meta.url)
const __dirname = dirname(__filename)
// ä» dist/index.js å›åˆ° tools æ ¹ç›®å½•
// dist/index.js -> cli -> tools
const CLI_ROOT = join(__dirname, '..')
const TOOLS_ROOT = join(CLI_ROOT, '..')
const SERVER_PATH = join(TOOLS_ROOT, 'server')
const WEB_PATH = join(TOOLS_ROOT, 'web')
const DEFAULT_SERVER_PORT = 3000
const DEFAULT_WEB_PORT = 5173

/**
 * UI å‘½ä»¤ä¸»å‡½ï¿½? * ä½¿ç”¨å¯ç¼–ç¨‹æ¥å£ç›´æ¥å¯åŠ¨æœï¿½? */
export async function uiCommand(options: UIOptions = {}): Promise<void> {
  const uiLogger = logger.withPrefix('UI')
  const host = options.host || '127.0.0.1'
  const serverPort = options.serverPort || DEFAULT_SERVER_PORT
  const webPort = options.webPort || DEFAULT_WEB_PORT
  
  // watch ç­‰åŒäº dev
  if (options.watch) {
    options.dev = true
  }
  
  // é»˜è®¤ä½¿ç”¨ç”Ÿäº§æ¨¡å¼ï¼ˆå…ˆæ„å»ºå†å¯åŠ¨ï¼‰ï¼Œé™¤éæ˜ç¡®æŒ‡å®š --dev æˆ– --watch
  const isDev = options.dev === true || options.watch === true

  let serverInstance: ServerInstance | null = null
  let webInstance: WebUIInstance | null = null
  let serverProcess: any = null // ç”¨äº watch æ¨¡å¼çš„è¿›ç¨‹
  // é»˜è®¤åŒæ—¶å¯åŠ¨ server å’Œ webï¼Œé™¤éæ˜ç¡®æŒ‡å®šåªå¯åŠ¨ä¸€ä¸ª
  const shouldStartServer = !options.webOnly
  const shouldStartWeb = !options.serverOnly

  // æ¸…ç†å‡½æ•°
  const cleanup = async () => {
    uiLogger.info('æ­£åœ¨æ¸…ç†èµ„æº...')
    try {
      if (webInstance) {
        await webInstance.stop().catch((err) => uiLogger.error('åœæ­¢ Web æœåŠ¡å¤±è´¥:', err))
      }
      if (serverProcess) {
        try {
          serverProcess.kill('SIGTERM')
          await serverProcess.catch(() => {})
        } catch (err) {
          // å¿½ç•¥æ¸…ç†é”™è¯¯
        }
      }
      if (serverInstance) {
        await serverInstance.stop().catch((err) => uiLogger.error('åœæ­¢ Server æœåŠ¡å¤±è´¥:', err))
      }
    } catch (err) {
      uiLogger.error('æ¸…ç†èµ„æºæ—¶å‡ºé”™', err)
    }
  }

  // æ³¨å†Œæ¸…ç†å¤„ç†å™¨
  process.on('SIGINT', cleanup)
  process.on('SIGTERM', cleanup)

  try {
    if (isDev) {
      // ========== å¼€å‘æ¨¡å¼ï¼ˆ--watchï¼‰==========
      // åŒæ—¶å¯åŠ¨ server å’Œ web çš„å¼€å‘æœåŠ¡å™¨
      uiLogger.info('ğŸš€ å¯åŠ¨å¼€å‘æ¨¡å¼ï¼ˆWatch æ¨¡å¼ï¼‰...')
      uiLogger.info('ğŸ’¡ ä»£ç ä¿®æ”¹ä¼šè‡ªåŠ¨é‡æ–°ç¼–è¯‘å’Œçƒ­æ›´æ–°')

      // å¯åŠ¨ Server å¼€å‘æœåŠ¡å™¨ï¼ˆé»˜è®¤å¯åŠ¨ï¼Œé™¤éæŒ‡å®š --web-onlyï¼‰
      if (shouldStartServer) {
        uiLogger.info('ğŸ› ï¸  å¯åŠ¨åç«¯ API æœåŠ¡ï¼ˆå¼€å‘æ¨¡å¼ï¼‰...')
        serverInstance = await startDevServer({
          port: serverPort,
          host,
          corsOrigins: [
            `http://${host === '0.0.0.0' ? 'localhost' : host}:${webPort}`,
            `http://localhost:${webPort}`,
            `http://127.0.0.1:${webPort}`,
          ],
          enableWebSocket: true,
          silent: false,
        })
        uiLogger.success(`âœ… API æœåŠ¡å·²å¯åŠ¨: ${serverInstance.getUrl()}`)
        uiLogger.info('ğŸ’¡ åç«¯ä»£ç ä¿®æ”¹ä¼šè‡ªåŠ¨é‡æ–°ç¼–è¯‘å’Œé‡å¯')
      }

      // å¯åŠ¨ Web å¼€å‘æœåŠ¡å™¨ï¼ˆé»˜è®¤å¯åŠ¨ï¼Œé™¤éæŒ‡å®š --server-onlyï¼‰
      if (shouldStartWeb) {
        uiLogger.info('ğŸ› ï¸  å¯åŠ¨å‰ç«¯å¼€å‘æœåŠ¡ï¼ˆçƒ­æ›´æ–°ï¼‰...')
        webInstance = await startDevUI({
          port: webPort,
          host,
          open: false,
          silent: false,
        })
        uiLogger.success(`âœ… Web æœåŠ¡å·²å¯åŠ¨: ${webInstance.getUrl()}`)
        uiLogger.info('ğŸ’¡ å‰ç«¯ä»£ç ä¿®æ”¹ä¼šè‡ªåŠ¨çƒ­æ›´æ–°ï¼ˆHMRï¼‰')
      }

      uiLogger.success('ğŸ‰ å¼€å‘æ¨¡å¼å¯åŠ¨å®Œæˆï¼')
      if (shouldStartServer && shouldStartWeb) {
        uiLogger.info(`ğŸ“ API: ${serverInstance?.getUrl() || `http://${host === '0.0.0.0' ? 'localhost' : host}:${serverPort}`}`)
        uiLogger.info(`ğŸ“ Web: ${webInstance?.getUrl() || `http://${host === '0.0.0.0' ? 'localhost' : host}:${webPort}`}`)
      }
      uiLogger.info('ğŸ’¡ æŒ‰ Ctrl+C åœæ­¢æ‰€æœ‰æœåŠ¡')

      // æ‰“å¼€æµè§ˆå™¨ï¼ˆé»˜è®¤æ‰“å¼€ï¼Œé™¤éæŒ‡å®š --no-openï¼‰
      if (options.open !== false && webInstance) {
        await open(webInstance.getUrl())
      }

    } else {
      // ========== ç”Ÿäº§æ¨¡å¼ ==========
      // å…ˆæ„å»ºï¼Œç„¶ååŒæ—¶å¯åŠ¨ server å’Œ web çš„ç”Ÿäº§ç‰ˆæœ¬
      uiLogger.info('ğŸš€ å¯åŠ¨ç”Ÿäº§æ¨¡å¼...')

      // æ„å»ºï¼ˆå¦‚æœéœ€è¦ï¼‰
      if (!options.noBuild) {
        uiLogger.info('ğŸ“¦ æ­£åœ¨æ„å»º...')
        
        // 1. æ„å»º Webï¼ˆå‰ç«¯åº”ç”¨ï¼‰
        if (shouldStartWeb) {
          uiLogger.info('  ğŸ“¦ æ„å»ºå‰ç«¯...')
          await execa('pnpm', ['build'], {
            cwd: WEB_PATH,
            stdio: 'inherit',
            shell: true,
          })
        }
        
        // 2. æ„å»º Serverï¼ˆåç«¯æœåŠ¡ï¼‰
        if (shouldStartServer) {
          uiLogger.info('  ğŸ“¦ æ„å»ºåç«¯...')
          await execa('pnpm', ['build'], {
            cwd: SERVER_PATH,
            stdio: 'inherit',
            shell: true,
          })
        }
        
        uiLogger.success('âœ… æ„å»ºå®Œæˆ')
      }

      // å¯åŠ¨ Server ç”Ÿäº§æœåŠ¡å™¨ï¼ˆé»˜è®¤å¯åŠ¨ï¼Œé™¤éæŒ‡å®š --web-onlyï¼‰
      if (shouldStartServer) {
        uiLogger.info('ğŸ› ï¸  å¯åŠ¨åç«¯æœåŠ¡...')
        serverInstance = await startProdServer({
          port: serverPort,
          host,
          corsOrigins: [
            `http://${host === '0.0.0.0' ? 'localhost' : host}:${serverPort}`,
            `http://localhost:${serverPort}`,
            `http://127.0.0.1:${serverPort}`,
            ...(shouldStartWeb ? [
              `http://${host === '0.0.0.0' ? 'localhost' : host}:${webPort}`,
              `http://localhost:${webPort}`,
              `http://127.0.0.1:${webPort}`,
            ] : []),
          ],
          enableWebSocket: true,
          silent: false,
        })
        uiLogger.success(`âœ… API æœåŠ¡å·²å¯åŠ¨: ${serverInstance.getUrl()}`)
      }

      // å¯åŠ¨ Web ç”Ÿäº§æœåŠ¡å™¨ï¼ˆé»˜è®¤å¯åŠ¨ï¼Œé™¤éæŒ‡å®š --server-onlyï¼‰
      if (shouldStartWeb) {
        uiLogger.info('ğŸ› ï¸  å¯åŠ¨å‰ç«¯æœåŠ¡...')
        webInstance = await startProdUI({
          port: webPort,
          host,
          open: false,
          silent: false,
        })
        uiLogger.success(`âœ… Web æœåŠ¡å·²å¯åŠ¨: ${webInstance.getUrl()}`)
      }

      uiLogger.success('ğŸ‰ ç”Ÿäº§æ¨¡å¼å¯åŠ¨å®Œæˆï¼')
      if (shouldStartServer && shouldStartWeb) {
        uiLogger.info(`ğŸ“ API: ${serverInstance?.getUrl() || `http://${host === '0.0.0.0' ? 'localhost' : host}:${serverPort}`}`)
        uiLogger.info(`ğŸ“ Web: ${webInstance?.getUrl() || `http://${host === '0.0.0.0' ? 'localhost' : host}:${webPort}`}`)
      } else if (shouldStartServer) {
        const uiUrl = `http://${host === '0.0.0.0' ? 'localhost' : host}:${serverPort}/ui`
        uiLogger.info(`ğŸ“ Web UI: ${uiUrl}`)
        uiLogger.info(`ğŸ“ API: ${serverInstance?.getUrl() || `http://${host === '0.0.0.0' ? 'localhost' : host}:${serverPort}/api`}`)
      }
      uiLogger.info('ğŸ’¡ æŒ‰ Ctrl+C åœæ­¢æœåŠ¡')

      // æ‰“å¼€æµè§ˆå™¨ï¼ˆé»˜è®¤æ‰“å¼€ï¼Œé™¤éæŒ‡å®š --no-openï¼‰
      if (options.open !== false) {
        if (webInstance) {
          await open(webInstance.getUrl())
        } else if (serverInstance) {
          await open(`http://${host === '0.0.0.0' ? 'localhost' : host}:${serverPort}/ui`)
        }
      }
    }

    // ä¿æŒè¿›ç¨‹è¿è¡Œ
    await new Promise(() => {}) // æ°¸ä¹…ç­‰å¾…ï¼Œç›´åˆ°æ”¶åˆ°ä¿¡å·
  } catch (error) {
    uiLogger.error('âŒ UI å¯åŠ¨å¤±è´¥:', error)
    await cleanup()
    throw error
  }
}

export const uiCommandHandler: CommandHandler = {
  name: 'ui',
  description: 'å¯åŠ¨å¯è§†åŒ–ç®¡ç†ç•Œé¢ï¼ˆé»˜è®¤åŒæ—¶å¯åŠ¨ Server å’Œ Webï¼‰',
  setup(cli: CAC) {
    cli
      .command('ui', 'å¯åŠ¨å¯è§†åŒ–ç®¡ç†ç•Œé¢ï¼ˆé»˜è®¤åŒæ—¶å¯åŠ¨ Server å’Œ Webï¼‰')
      .option('--host <host>', 'Host to bind', { default: '127.0.0.1' })
      .option('--server-port <port>', 'Server port')
      .option('--web-port <port>', 'Web port')
      .option('--server-only', 'åªå¯åŠ¨ Serverï¼ˆä¸å¯åŠ¨ Webï¼‰')
      .option('--web-only', 'åªå¯åŠ¨ Webï¼ˆä¸å¯åŠ¨ Serverï¼‰')
      .option('--no-build', 'è·³è¿‡æ„å»ºæ­¥éª¤ï¼ˆç”Ÿäº§æ¨¡å¼ï¼‰')
      .option('--dev', 'å¼€å‘æ¨¡å¼ï¼ˆå¯ç”¨çƒ­æ›´æ–°ï¼Œç­‰åŒäº --watchï¼‰')
      .option('--watch', 'Watch æ¨¡å¼ï¼ˆå¯ç”¨çƒ­æ›´æ–°ï¼Œç­‰åŒäº --devï¼‰')
      .option('--prod', 'ç”Ÿäº§æ¨¡å¼ï¼ˆé»˜è®¤ï¼Œå…ˆæ„å»ºå†å¯åŠ¨ï¼Œä½¿ç”¨æ‰“åŒ…åçš„ä»£ç ï¼‰')
      .option('--no-open', 'ä¸è‡ªåŠ¨æ‰“å¼€æµè§ˆå™¨')
      .action(async (options) => {
        try {
          // å¦‚æœæŒ‡å®šäº† --prodï¼Œåˆ™æ˜ç¡®è®¾ç½® dev ä¸º false
          if (options.prod) {
            options.dev = false
            options.watch = false
          }
          // watch å’Œ dev äº’æ–¥
          if (options.watch) {
            options.dev = true
          }
          await uiCommand(options)
        } catch (error) {
          logger.error('UI command failed:', error)
          process.exit(1)
        }
      })
  },
  async execute(options: UIOptions) {
    return uiCommand(options)
  },
}
